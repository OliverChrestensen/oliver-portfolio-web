name: Deploy Portfolio

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy via SSH
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          DOCKER_COMPOSE_PATH: ${{ secrets.DOCKER_COMPOSE_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
          set -e

          cd $DOCKER_COMPOSE_PATH

          # Tjek om containeren eksisterer
          if docker ps -a --format '{{.Names}}' | grep -q 'portfolio-blue'; then
            echo "Stopping and removing existing portfolio-blue container..."
            docker stop portfolio-blue
            docker rm portfolio-blue
          fi

          # Byg og start containeren
          docker-compose build
          docker-compose up -d

          # Connect containeren til nginx proxy netvÃ¦rket
          if ! docker network inspect nginx-proxy-manager_default | grep -q 'portfolio-blue'; then
            docker network connect nginx-proxy-manager_default portfolio-blue
            echo "Connected portfolio-blue to nginx-proxy-manager_default network."
          fi

          EOF

