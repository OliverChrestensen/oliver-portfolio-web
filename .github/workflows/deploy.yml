name: Deploy Portfolio

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          cd ${{ secrets.DOCKER_COMPOSE_PATH }} &&
          
          # Blue/Green logic
          CURRENT_COLOR=\$(docker ps --format '{{.Names}}' | grep 'portfolio-' | head -n 1 | sed 's/portfolio-//')
          if [ \"\$CURRENT_COLOR\" = \"blue\" ]; then
            NEW_COLOR=green
          else
            NEW_COLOR=blue
          fi
          
          echo 'Current live color: ' \$CURRENT_COLOR
          echo 'New deploy color: ' \$NEW_COLOR

          # Build and start new container
          docker-compose -f docker-compose.yml -p portfolio-\$NEW_COLOR up -d --build
          
          # Wait a few seconds to ensure container is running
          sleep 5
          
          # Stop old container if exists
          if [ ! -z \"\$CURRENT_COLOR\" ]; then
            docker stop portfolio-\$CURRENT_COLOR
            docker rm portfolio-\$CURRENT_COLOR
          fi
          
          # Optionally, rename new container to portfolio-blue for consistency
          docker rename portfolio-\$NEW_COLOR portfolio-blue
          "

