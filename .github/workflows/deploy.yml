name: Deploy Portfolio

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          
          cd ${{ secrets.DOCKER_COMPOSE_PATH }} || exit 1
          echo '--- Starting Blue/Green deployment ---'

          # Detect current live color
          CURRENT_COLOR=\$(docker ps --format '{{.Names}}' | grep '^portfolio-' | head -n 1 | sed 's/portfolio-//')
          if [ \"\$CURRENT_COLOR\" = \"blue\" ]; then
            NEW_COLOR=green
          else
            NEW_COLOR=blue
          fi

          echo 'Current live color: ' \$CURRENT_COLOR
          echo 'New deploy color: ' \$NEW_COLOR

          echo '--- Building and starting new container ---'
          docker-compose -f docker-compose.yml -p portfolio-\$NEW_COLOR up -d --build

          # Wait until container is healthy or timeout after 30s
          echo 'Waiting for new container to become healthy...'
          for i in {1..30}; do
            if docker ps --format '{{.Names}}' | grep -q \"portfolio-\$NEW_COLOR\"; then
              echo 'âœ… New container is up.'
              break
            fi
            sleep 1
          done

          echo '--- Cleaning up old container ---'
          if [ ! -z \"\$CURRENT_COLOR\" ] && docker ps -a --format '{{.Names}}' | grep -q \"portfolio-\$CURRENT_COLOR\"; then
            docker stop portfolio-\$CURRENT_COLOR || true
            docker rm portfolio-\$CURRENT_COLOR || true
          else
            echo 'No old container found, skipping cleanup.'
          fi

          echo '--- Renaming and network setup ---'
          # Remove any leftover container name conflicts
          docker rm portfolio-blue -f || true

          # Rename the new container to portfolio-blue (our standard name)
          docker rename portfolio-\$NEW_COLOR portfolio-blue || true

          # Connect to Nginx Proxy Manager network if it exists
          if docker network inspect nginx-proxy-manager_default >/dev/null 2>&1; then
            echo 'Connecting portfolio-blue to nginx-proxy-manager_default network...'
            docker network connect nginx-proxy-manager_default portfolio-blue || true
          else
            echo 'Network nginx-proxy-manager_default not found, skipping connect.'
          fi

          echo '--- Deployment complete ---'
          docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
          "
