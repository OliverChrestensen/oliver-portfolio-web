name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
          cd ${{ secrets.DOCKER_COMPOSE_PATH }}

          echo '--- Pulling latest changes from GitHub ---'
          git fetch origin main
          git reset --hard origin/main

          # Determine which color is live
          CURRENT_COLOR=\$(docker ps --format '{{.Names}}' | grep 'portfolio-' | head -n 1 | sed 's/portfolio-//')
          if [ "\$CURRENT_COLOR" = "blue" ]; then
            NEW_COLOR=green
          else
            NEW_COLOR=blue
          fi
          echo 'Current live color:' \$CURRENT_COLOR
          echo 'New deploy color:' \$NEW_COLOR

          # Stop and remove old build container if exists (cleanup)
          docker rm -f portfolio-\$NEW_COLOR || true

          # Build and start new container
          docker-compose -p portfolio-\$NEW_COLOR up -d --build || exit 1

          # Wait a bit for startup
          sleep 10

          # Check if container started successfully
          if docker ps --format '{{.Names}}' | grep -q "portfolio-\$NEW_COLOR"; then
            echo 'New container started successfully.'
          else
            echo 'ERROR: New container did not start properly, keeping old version.'
            exit 1
          fi

          # Stop and remove old live container if exists
          if [ ! -z "\$CURRENT_COLOR" ]; then
            echo 'Stopping old container portfolio-'\$CURRENT_COLOR
            docker rm -f portfolio-\$CURRENT_COLOR || true
          fi

          # Rename new container to blue (stable name)
          docker rename portfolio-\$NEW_COLOR portfolio-blue || true

          # Connect to proxy network
          docker network connect nginx-proxy-manager_default portfolio-blue || true

          echo '--- Deployment complete ---'
          EOF
